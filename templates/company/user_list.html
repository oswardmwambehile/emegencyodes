{% extends "company/base.html" %}
{% load static %}

{% block content %}
{% include "company/sidebar.html" %}
<div class="main-panel">
  <div class="main-header">
    {% include "company/nav.html" %}
  </div>

  <div class="container">
    <div class="page-inner">

      <!-- ðŸ”¹ Page Header -->
      <div class="d-flex justify-content-between align-items-center mt-4 mb-3 flex-wrap gap-3">
        <h3 class="mb-0"><i class="fas fa-users"></i> Users of the Company</h3>
        <a href="{% url 'register'%}" class="btn btn-primary">
          <i class="fas fa-user-plus"></i> Add Company User
        </a>
      </div>

      <!-- ðŸ”¹ Django Messages -->
      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- ðŸ”¹ Search -->
      <form method="get" class="d-flex mb-3 gap-2" style="max-width: 500px;">
        <input type="text" name="q" value="{{ query }}" placeholder="Search user by name or company..." class="form-control">
        <button type="submit" class="btn btn-outline-primary">
          <i class="fas fa-search"></i>
        </button>
        {% if query %}
          <a href="{% url 'user_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-times"></i>
          </a>
        {% endif %}
      </form>

      <!-- ðŸ”¹ Table -->
      <div class="table-wrapper" style="overflow-x: auto;">
        <table class="table table-bordered table-striped align-middle" style="min-width: 1000px;">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th><i class="fas fa-user"></i> First Name</th>
              <th><i class="fas fa-user"></i> Last Name</th>
              <th><i class="fas fa-building"></i> Company Name</th>
              <th><i class="fas fa-user-shield"></i> Role</th>
              <th><i class="fas fa-cogs"></i> Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              <tr id="user-row-{{ user.id }}" class="{% if not user.is_active %}table-danger{% endif %}">
                <td>{{ forloop.counter }}</td>
                <td>{{ user.first_name|default:"-" }}</td>
                <td>{{ user.last_name|default:"-" }}</td>
                <td>{{ user.company_name|default:"-" }}</td>
                <td>
                  {% if user.is_superuser %}
                    <span class="badge bg-danger">Admin</span>
                  {% elif user.is_staff %}
                    <span class="badge bg-info">Staff</span>
                  {% else %}
                    <span class="badge bg-secondary">User</span>
                  {% endif %}
                </td>
                <td>
                  <!-- View -->
                  <a href="" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i>
                  </a>

                  <!-- Edit -->
                  {% if not user.is_superuser and user != request.user %}
                    <a href="{% url 'edit_user' user.id%}" class="btn btn-sm btn-outline-warning">
                      <i class="fas fa-edit"></i>
                    </a>
                  {% else %}
                    <button class="btn btn-sm btn-outline-secondary" disabled>
                      <i class="fas fa-edit"></i>
                    </button>
                  {% endif %}

                  <!-- Enable/Disable -->
                  {% if not user.is_superuser and user != request.user %}
                    <form action="{% url 'toggle_user_status' user.id %}" method="post" class="d-inline toggle-user-form">
                      {% csrf_token %}
                      <button 
                        type="submit"
                        class="btn btn-sm {% if user.is_active %}btn-outline-danger{% else %}btn-outline-success{% endif %} toggle-status-btn"
                        data-user-id="{{ user.id }}"
                        data-user-active="{{ user.is_active }}"
                      >
                        <i class="fas {% if user.is_active %}fa-user-slash{% else %}fa-user-check{% endif %}"></i>
                      </button>
                    </form>
                  {% else %}
                    <button class="btn btn-sm btn-outline-secondary" disabled>
                      <i class="fas fa-user-slash"></i>
                    </button>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">
                  <i class="fas fa-info-circle"></i> No users found.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </div>
  </div>
</div>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- JavaScript for dynamic Enable/Disable -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.toggle-user-form').forEach(form => {
      form.addEventListener('submit', function (e) {
        const button = form.querySelector('.toggle-status-btn');
        const userId = button.dataset.userId;
        const isActive = button.dataset.userActive === 'True';
        const row = document.getElementById(`user-row-${userId}`);

        // Confirm dialog
        const confirmText = isActive
          ? "Are you sure you want to disable this user?"
          : "Do you want to enable this user?";
        if (!confirm(confirmText)) {
          e.preventDefault();  
          return;
        }

        // AJAX request
        e.preventDefault();

        fetch(form.action, {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert(data.error);
            return;
          }

          // Update button dynamically
          const icon = button.querySelector('i');
          if (data.is_active) {
            button.classList.remove('btn-outline-success');
            button.classList.add('btn-outline-danger');
            icon.classList.remove('fa-user-check');
            icon.classList.add('fa-user-slash');
            button.dataset.userActive = "True";
            row.classList.remove("table-danger");
          } else {
            button.classList.remove('btn-outline-danger');
            button.classList.add('btn-outline-success');
            icon.classList.remove('fa-user-slash');
            icon.classList.add('fa-user-check');
            button.dataset.userActive = "False";
            row.classList.add("table-danger");
          }
        })
        .catch(error => {
          alert("Something went wrong. Please try again.");
          console.error("Toggle error:", error);
        });
      });
    });
  });
</script>
{% endblock %}
